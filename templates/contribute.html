{% extends "base.html" %}

{% block title %}Contribute to {{ capsule[1] }}'s Capsule{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-heart me-2"></i>Add Your Birthday Wish for {{ capsule[1] }}</h2>
                <p class="mb-0">Your message will be revealed on {{ capsule[3] }}‚Äîthey'll love it!</p>
            </div>
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data" id="contributeForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contributor_name" class="form-label">
                                <i class="fas fa-user me-1"></i>Your name
                            </label>
                            <input type="text" class="form-control" id="contributor_name" name="contributor_name" required 
                                   placeholder="So they know who it's from">
                            <div class="form-text">Just your first name works great!</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="contributor_email" class="form-label">
                                <i class="fas fa-envelope me-1"></i>Your email (optional)
                            </label>
                            <input type="email" class="form-control" id="contributor_email" name="contributor_email" placeholder="your.email@example.com">
                            <div class="form-text">In case we need to reach you</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contribution_type" class="form-label">
                                <i class="fas fa-heart me-1"></i>What kind of wish is this?
                            </label>
                            <select class="form-select" id="contribution_type" name="contribution_type">
                                <option value="message">A birthday message üéÇ</option>
                                <option value="memory">A shared memory üí≠</option>
                                <option value="wish">A birthday wish üåü</option>
                                <option value="creative">Something creative üé®</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="contribution-tabs mb-4">
                        <ul class="nav nav-pills nav-justified mb-3" id="contributionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="message-tab" data-bs-toggle="pill" data-bs-target="#message-pane" type="button" role="tab">
                                    <i class="fas fa-comment me-2"></i>Write a Message
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ascii-tab" data-bs-toggle="pill" data-bs-target="#ascii-pane" type="button" role="tab">
                                    <i class="fas fa-pencil-alt me-2"></i>Draw Art
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="image-tab" data-bs-toggle="pill" data-bs-target="#image-pane" type="button" role="tab">
                                    <i class="fas fa-image me-2"></i>Add a Photo
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="contributionTabContent">
                            <div class="tab-pane fade show active" id="message-pane" role="tabpanel">
                                <label for="message" class="form-label">
                                    <i class="fas fa-heart me-1"></i>Your Birthday Message
                                </label>
                                <textarea class="form-control" id="message" name="message" rows="6" 
                                          placeholder="Write something from your heart...&#10;&#10;Maybe share your favorite memory together, tell them what makes them special, or wish them something wonderful for the year ahead!"></textarea>
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1"></i>Don't overthink it‚Äîjust be yourself! They'll treasure whatever you write.
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="ascii-pane" role="tabpanel">
                                <label for="ascii_art" class="form-label">
                                    <i class="fas fa-paint-brush me-1"></i>Draw Something Fun with Text
                                </label>
                                <div class="ascii-tools mb-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertAsciiTemplate('cake')">üéÇ Cake</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertAsciiTemplate('balloons')">üéà Balloons</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertAsciiTemplate('party')">üéâ Party</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertAsciiTemplate('heart')">‚ù§Ô∏è Heart</button>
                                </div>
                                <textarea class="form-control ascii-art" id="ascii_art" name="ascii_art" rows="10" 
                                          placeholder="Create your art here...&#10;&#10;Try using: * - | / \ ( ) < > to make fun drawings! Or click a button above to start with a template."></textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>Click the buttons above for ready-made designs, or create your own masterpiece!
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="image-pane" role="tabpanel">
                                <label for="image" class="form-label">
                                    <i class="fas fa-camera me-1"></i>Upload a Special Photo
                                </label>
                                <div class="image-upload-area">
                                    <input type="file" class="form-control" id="image" name="image" accept="image/*" onchange="previewImage(this)">
                                    <div class="form-text mb-3">
                                        <i class="fas fa-info-circle me-1"></i>Share a photo of you two, a fun memory, or anything special (up to 5MB)
                                    </div>
                                    <div id="imagePreview" class="image-preview" style="display: none;">
                                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded">
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeImage()">
                                            <i class="fas fa-trash me-1"></i>Remove Photo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-gift me-2"></i>Add My Wish to the Surprise
                        </button>
                        <p class="small text-muted mt-2">It'll stay secret until their birthday!</p>
                    </div>
                </form>
                
                <!-- Inspiration Section -->
                <div class="row mt-5">
                    <div class="col-md-6 mb-3">
                        <div class="p-4" style="background: var(--color-surface-2); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                            <h5><i class="fas fa-lightbulb me-2"></i>Need Ideas?</h5>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2"><i class="fas fa-star text-warning me-2"></i>Tell them about your favorite memory together</li>
                                <li class="mb-2"><i class="fas fa-star text-warning me-2"></i>Describe what makes them such a great friend</li>
                                <li class="mb-2"><i class="fas fa-star text-warning me-2"></i>Share your hopes for their next year</li>
                                <li class="mb-2"><i class="fas fa-star text-warning me-2"></i>Include an inside joke only they'd understand</li>
                                <li class="mb-0"><i class="fas fa-star text-warning me-2"></i>Just tell them how much they mean to you</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="p-4" style="background: var(--color-surface-2); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                            <h5><i class="fas fa-palette me-2"></i>Art Examples</h5>
                            <div class="ascii-art small">
Simple Cake:       Balloons:
  ___                o  o
 |[_]|              /|\/|\
 |___|             / |  |\
                                    
Happy Face:        Heart:
   :-D             **   **
   \o/            **** ****
    |            ***********
   / \            *********
                            </div>
                            <p class="small mb-0 mt-2 text-muted">Or create your own! Anything goes!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-pills .nav-link {
        border-radius: 999px;
        margin: 0 0.25rem;
        transition: var(--transition);
    }
    
    .nav-pills .nav-link.active {
        background: var(--color-primary);
    }
    
    .ascii-tools .btn {
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .image-upload-area {
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        text-align: center;
        transition: var(--transition);
    }
    
    .image-upload-area:hover {
        border-color: var(--color-primary);
        background: var(--color-surface-2);
    }
    
    .image-preview img {
        max-width: 300px;
        max-height: 200px;
        object-fit: cover;
        border-radius: var(--radius-md);
    }
</style>

<script>
function insertAsciiTemplate(type) {
    const textarea = document.getElementById('ascii_art');
    let template = '';
    
    switch(type) {
        case 'cake':
            template = `   ___     ___
  |[_]|   |[_]|
  |   |___|   |
  |___________|`;
            break;
        case 'balloons':
            template = `    o  o    o
   /|\\/|\\/|\\
  / |  |  | \\
   \\|__|__|/
    ^^^^^^^^`;
            break;
        case 'party':
            template = `  \\o/  \\o/  \\o/
   |    |    |
  / \\  / \\  / \\
 PARTY TIME!!!`;
            break;
        case 'heart':
            template = `   **   **
 **** ****
***********
 *********
  *****
   ***
    *`;
            break;
    }
    
    textarea.value = textarea.value + (textarea.value ? '\\n\\n' : '') + template;
    textarea.focus();
}

function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        }
        
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

function removeImage() {
    document.getElementById('image').value = '';
    document.getElementById('imagePreview').style.display = 'none';
}

// Form validation
document.getElementById('contributeForm').addEventListener('submit', function(e) {
    const message = document.getElementById('message').value.trim();
    const asciiArt = document.getElementById('ascii_art').value.trim();
    const image = document.getElementById('image').files.length > 0;
    
    if (!message && !asciiArt && !image) {
        e.preventDefault();
        alert('Please add at least one type of contribution (message, ASCII art, or image)!');
        return false;
    }
    
    // Check image size
    const imageFile = document.getElementById('image').files[0];
    if (imageFile && imageFile.size > 5 * 1024 * 1024) {
        e.preventDefault();
        alert('Image file is too large! Please use files smaller than 5MB.');
        return false;
    }
    
    return true;
});

// Auto-save draft functionality
let autoSaveTimer;
function autoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        const formData = {
            name: document.getElementById('contributor_name').value,
            message: document.getElementById('message').value,
            ascii_art: document.getElementById('ascii_art').value
        };
        localStorage.setItem('contributionDraft_{{ capsule[0] }}', JSON.stringify(formData));
    }, 2000);
}

// Load draft on page load
document.addEventListener('DOMContentLoaded', function() {
    const draft = localStorage.getItem('contributionDraft_{{ capsule[0] }}');
    if (draft) {
        const data = JSON.parse(draft);
        document.getElementById('contributor_name').value = data.name || '';
        document.getElementById('message').value = data.message || '';
        document.getElementById('ascii_art').value = data.ascii_art || '';
    }
    
    // Add auto-save listeners
    ['contributor_name', 'message', 'ascii_art'].forEach(id => {
        document.getElementById(id).addEventListener('input', autoSave);
    });
});

// Clear draft on successful submission
document.getElementById('contributeForm').addEventListener('submit', function() {
    localStorage.removeItem('contributionDraft_{{ capsule[0] }}');
});
</script>
{% endblock %}
